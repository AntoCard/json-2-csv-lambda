# json-2-csv-lambda

Clouformation stack that creates a S3 bucket and a Lambda function that automatically transforms json files to csv when a file is uploaded. And posts a message to Slack if there is a problem.

For cost saving it uses S3 infrecuent access storage for the json files.

It recreates any csv files erased if the original json is still present in `json/`.


## Getting Started

Instructions to set up and run this project

### Prerequisites

You need valid AWS credentials either in env vars or in the `.aws` directory.
https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html

aws-cli and bash to deploy using the "deploy" wrapper

### Installing

Clone the repository

```
git clone git@github.com:AntoCard/json-2-csv-lambda.git
```

Install aws-cli

```
pip install awscli
```


## Deployment

From the project base directory run the wrapper script:

```
./deploy -s stackname -l lambda_bucket -b bucket -c channel -t token
```
Where required options are:

```
  -s = Stack name - Name of the Cloudformation stack
  -l = Lambda bucket - S3 bucket name where to store the lambda - Will be created if doesn't exist
  -b = Bucket - S3 bucket where to store csv and json files - Will be created in the stack.
  -c = Channel - Slack channel -  Channel where to post json processing errors
  -t = Token - Slack token - Needed to authenticate against your Slack account

```

## Testing

### Using imdb2s3:

The `utils/imdb2s3/imdb2s3` Python script can be use to easily upload a json file to the S3 bucket we created in the stack.

Usage is:

```
Search for a movie in IMDB and upload the json result to S3

optional arguments:
  -h, --help            show this help message and exit
  --bucket BUCKET, -b BUCKET
                        bucket where to upload json
  --key KEY, -k KEY     imdb api key
  --movie MOVIE, -m MOVIE
                        movie name (use + instead of spaces)
```

Example:

```
./imdb-get.py -m 'The+Italian+Job' -k my_imdb_api_key -b mybucket
```

### Using an OMDB json example or any other json file

In the `examples` directory you can find three json files:

`it.json` a valid json file with info about the 2017 movie "It" generated by the OMDB
`tmdb.json` a valid json file with info generated in IMDB in a search for "Jack Reaper"
`invalid_json_file.json` an invalid json file for testing pourposes

### How to test and expected behaviour

Use the imdb2s3 tool or upload any of the example files to a `json/` directory in the bucket created by the stack to test automatic csv creation.

For testing automatic recreation of a csv file, erase any of the .csv files in the bucket `csv/` directory. 

## Authors

* **Antonio Cardenes** - *Initial work* - [AntoCard](https://github.com/AntoCard)


## License

This project is licensed under the GPL License - see the [LICENSE](LICENSE) file for details

